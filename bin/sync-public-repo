#!/usr/bin/env bash
set -euo pipefail

# Mirror zorto source from the dkdc monorepo to lostmygithubaccount/zorto.
# Uses rsync to copy files, then commits and pushes to the public repo.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ZORTO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
PUBLIC_REPO="lostmygithubaccount/zorto"
CLONE_DIR="${ZORTO_DIR}/.sync-repo"

info()  { printf '\033[1;35m[sync]\033[0m %s\n' "$*"; }
err()   { printf '\033[1;31m[sync]\033[0m %s\n' "$*" >&2; }

# ──────────────────────────────────────
# clone or update the public repo
# ──────────────────────────────────────

if [ -d "$CLONE_DIR/.git" ]; then
    info "updating existing clone..."
    git -C "$CLONE_DIR" fetch origin
    git -C "$CLONE_DIR" reset --hard origin/main 2>/dev/null || git -C "$CLONE_DIR" checkout --orphan main
else
    info "cloning public repo..."
    gh repo clone "$PUBLIC_REPO" "$CLONE_DIR" 2>/dev/null || {
        # empty repo — initialize locally
        mkdir -p "$CLONE_DIR"
        git -C "$CLONE_DIR" init
        git -C "$CLONE_DIR" remote add origin "https://github.com/${PUBLIC_REPO}.git"
        git -C "$CLONE_DIR" checkout -b main
    }
fi

# ──────────────────────────────────────
# sync files
# ──────────────────────────────────────

info "syncing files..."

rsync -a --delete \
    --exclude='.git/' \
    --exclude='.sync-repo/' \
    --exclude='target/' \
    --exclude='.venv/' \
    --exclude='.ruff_cache/' \
    --exclude='__pycache__/' \
    --exclude='*.pyc' \
    --exclude='*.so' \
    --exclude='*.egg-info/' \
    --exclude='external/' \
    --exclude='examples/' \
    --exclude='public/' \
    --exclude='.DS_Store' \
    "$ZORTO_DIR/" "$CLONE_DIR/"

# ──────────────────────────────────────
# commit and push
# ──────────────────────────────────────

cd "$CLONE_DIR"

git add -A

if git diff --cached --quiet; then
    info "no changes to sync"
    exit 0
fi

git commit -m "sync from internal repository"

info "pushing to origin/main..."
git push -u origin main

info "done — https://github.com/lostmygithubaccount/zorto"
